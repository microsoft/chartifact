<!DOCTYPE html>
<html>
<head>
    <title>Chartifact Mobile Tombstoning Fix Test</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { 
            margin: 20px; 
            font-family: Arial, sans-serif;
            line-height: 1.4;
        }
        #preview { 
            width: 100%; 
            height: 400px; 
            border: 2px solid #007acc; 
            margin: 10px 0;
            background: #f9f9f9;
        }
        #loading, #help { 
            display: none; 
            padding: 10px; 
            background: #e8f4fd;
            border: 1px solid #007acc;
            margin: 5px 0;
        }
        .button { 
            padding: 10px 15px; 
            margin: 5px; 
            background: #007acc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .button:hover {
            background: #005a9e;
        }
        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        #status { 
            margin-top: 15px; 
            padding: 10px; 
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .status-line {
            margin: 2px 0;
            padding: 2px 0;
        }
        .error { color: #d32f2f; }
        .success { color: #2e7d32; }
        .info { color: #1976d2; }
        
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }
        
        h1 { color: #333; margin-bottom: 10px; }
        h2 { color: #555; margin: 15px 0 10px 0; font-size: 18px; }
    </style>
</head>
<body>
    <h1>üîß Chartifact Mobile Tombstoning Fix Test</h1>
    
    <div class="test-section">
        <h2>1. Load Test Document</h2>
        <p>First, load a test document to initialize the sandbox:</p>
        <button class="button" onclick="loadDocument()">Load Test Document</button>
    </div>
    
    <div class="test-section">
        <h2>2. Verify Sandbox</h2>
        <p>Check if the sandbox is working properly:</p>
        <button class="button" onclick="testSandboxFunctional()" id="testBtn" disabled>Test Sandbox Status</button>
    </div>
    
    <div class="test-section">
        <h2>3. Simulate Mobile Tombstoning</h2>
        <p>Simulate what happens when mobile browsers garbage collect blob URLs:</p>
        <button class="button" onclick="simulateTombstoning()" id="tombstoneBtn" disabled>Simulate Tombstoning</button>
        <button class="button" onclick="triggerRestoration()" id="restoreBtn" disabled>Trigger Restoration</button>
    </div>
    
    <div id="loading">Loading Chartifact...</div>
    <div id="help">Help: Load a document to get started</div>
    <div id="preview"></div>
    
    <div id="status"></div>

    <script src="./docs/dist/v1/chartifact.host.umd.js"></script>
    <script>
        let host = null;
        let documentLoaded = false;
        
        function log(message, type = 'info') {
            const status = document.getElementById('status');
            const line = document.createElement('div');
            line.className = `status-line ${type}`;
            line.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            status.appendChild(line);
            status.scrollTop = status.scrollHeight;
            console.log(message);
        }
        
        function updateButtons() {
            document.getElementById('testBtn').disabled = !documentLoaded;
            document.getElementById('tombstoneBtn').disabled = !documentLoaded;
            document.getElementById('restoreBtn').disabled = !documentLoaded;
        }
        
        function loadDocument() {
            try {
                log('Initializing Chartifact host...', 'info');
                
                host = new Chartifact.host.Listener({
                    preview: '#preview',
                    loading: '#loading',
                    help: '#help',
                    onApprove: (message) => {
                        log(`Approval request for ${message.specs.length} specs`, 'info');
                        return message.specs;
                    }
                });
                
                const testMarkdown = `# üìä Mobile Tombstoning Test Document

This is a test document to verify the mobile browser tombstoning fix works correctly.

## Test Chart
{"type": "chart", "data": [{"x": 1, "y": 2}, {"x": 2, "y": 4}, {"x": 3, "y": 6}], "vega-lite": {"mark": "point", "encoding": {"x": {"field": "x", "type": "quantitative"}, "y": {"field": "y", "type": "quantitative"}}}}

## Features Tested

- ‚úÖ Blob URL functionality detection
- ‚úÖ Document content accessibility verification  
- ‚úÖ Automatic restoration on visibility change
- ‚úÖ Proper sandbox recreation

If you can see this content and the chart above, the sandbox is working correctly!
`;
                
                host.renderMarkdown(testMarkdown);
                documentLoaded = true;
                updateButtons();
                log('‚úÖ Document loaded successfully!', 'success');
                
            } catch (error) {
                log(`‚ùå Error loading document: ${error.message}`, 'error');
            }
        }
        
        function testSandboxFunctional() {
            if (!host) {
                log('‚ùå No document loaded', 'error');
                return;
            }
            
            try {
                // Note: isSandboxFunctional is private, so we'll test the public behavior
                if (host.sandbox && host.sandbox.iframe) {
                    const iframe = host.sandbox.iframe;
                    log(`üìã Sandbox Status:`, 'info');
                    log(`  - Iframe exists: ‚úÖ`, 'info');
                    log(`  - Iframe src: ${iframe.src.substring(0, 50)}...`, 'info');
                    log(`  - Content window: ${iframe.contentWindow ? '‚úÖ' : '‚ùå'}`, iframe.contentWindow ? 'info' : 'error');
                    
                    // Test if we can access document
                    try {
                        const doc = iframe.contentWindow.document;
                        const hasContent = doc && doc.body && doc.body.children.length > 0;
                        log(`  - Document accessible: ${hasContent ? '‚úÖ' : '‚ùå'}`, hasContent ? 'info' : 'error');
                        log(`  - Body children count: ${doc.body ? doc.body.children.length : 0}`, 'info');
                    } catch (e) {
                        log(`  - Document access: ‚ùå (${e.message})`, 'error');
                    }
                } else {
                    log('‚ùå Sandbox not available', 'error');
                }
            } catch (error) {
                log(`‚ùå Error testing sandbox: ${error.message}`, 'error');
            }
        }
        
        function simulateTombstoning() {
            if (!host) {
                log('‚ùå No document loaded', 'error');
                return;
            }
            
            try {
                log('üîÑ Simulating mobile browser tombstoning...', 'info');
                
                if (host.sandbox && host.sandbox.iframe) {
                    const iframe = host.sandbox.iframe;
                    const originalSrc = iframe.src;
                    log(`Original src: ${originalSrc.substring(0, 50)}...`, 'info');
                    
                    // Simulate tombstoning by creating and immediately revoking a blob URL
                    const fakeHtml = '<!DOCTYPE html><html><body>Tombstoned content</body></html>';
                    const fakeBlob = new Blob([fakeHtml], { type: 'text/html' });
                    const fakeBlobUrl = URL.createObjectURL(fakeBlob);
                    
                    // Immediately revoke it to simulate garbage collection
                    URL.revokeObjectURL(fakeBlobUrl);
                    
                    // Set the iframe to use the revoked blob URL
                    iframe.src = fakeBlobUrl;
                    
                    log(`üóëÔ∏è Simulated tombstoning - iframe src set to revoked blob URL`, 'info');
                    log(`New src: ${fakeBlobUrl}`, 'info');
                    
                    // Test the detection after a brief delay
                    setTimeout(() => {
                        testSandboxFunctional();
                        log('üí° Now try "Trigger Restoration" to test the fix!', 'info');
                    }, 500);
                    
                } else {
                    log('‚ùå No sandbox iframe to tombstone', 'error');
                }
            } catch (error) {
                log(`‚ùå Error simulating tombstoning: ${error.message}`, 'error');
            }
        }
        
        function triggerRestoration() {
            if (!host) {
                log('‚ùå No document loaded', 'error');
                return;
            }
            
            try {
                log('üîÑ Triggering visibility change event (restoration)...', 'info');
                
                // Simulate the page becoming visible again (like returning from background)
                const event = new Event('visibilitychange');
                Object.defineProperty(document, 'visibilityState', {
                    value: 'visible', 
                    configurable: true
                });
                
                document.dispatchEvent(event);
                
                // Check the result after restoration
                setTimeout(() => {
                    testSandboxFunctional();
                    log('‚úÖ Restoration test completed!', 'success');
                }, 1000);
                
            } catch (error) {
                log(`‚ùå Error triggering restoration: ${error.message}`, 'error');
            }
        }
        
        // Initialize
        log('üöÄ Chartifact Mobile Tombstoning Test Page Ready', 'success');
        log('üì± This test verifies that the fix properly detects and recovers from mobile browser tombstoning', 'info');
        updateButtons();
    </script>
</body>
</html>