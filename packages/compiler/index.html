<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chartifact Compiler test</title>

    <!-- TODO: get chartifact css reset -->
     
    <link href="https://unpkg.com/tabulator-tables@6.3.0/dist/css/tabulator.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/markdown-it/dist/markdown-it.min.js"></script>
    <script src="https://unpkg.com/css-tree/dist/csstree.js"></script>
    <script src="https://unpkg.com/js-yaml/dist/js-yaml.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega@5.29.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5.20.1"></script>
    <script src="https://unpkg.com/tabulator-tables@6.3.0/dist/js/tabulator.min.js"></script>

    <style>
        #editor {
            background-color: snow;
            visibility: hidden;
            opacity: 0;
            position: fixed;
            top: 0;
            left: -50%;
            width: 50%;
            height: 100vh;
            resize: none;
            padding: 20px;
            box-sizing: border-box;
            pointer-events: none;
            transition: left 0.3s ease-in-out, opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
            display: grid;
        }

        body.edit #editor {
            visibility: visible;
            opacity: 1;
            left: 0%;
            pointer-events: auto;
        }

        #content {
            transition: margin-left 0.3s ease-in-out;
        }

        body.edit #content {
            margin-left: 50%;
            padding-left: 8px;
            /* mimic the body margin */
        }
    </style>
</head>

<body class="edit">

    <div id="editor">
        <textarea id="json-input" placeholder="Type your Interactive Document json here...">
{
    "$schema": "../../../schema/idoc_v1.json",
    "notes": [
        "This is a test document for the Chartifact compiler.",
        "It includes various data sources and a simple chart.",
        9,
        {"foo": "bar", "baz": 9}
    ],
    "title": "Feature: Data Sources",
    "dataLoaders": [
        {
            "dataSourceName": "jsonData",
            "type": "inline",
            "format": "json",
            "content": [
                {"item": "Stapler", "category": "Office Tools", "price": 12.99, "inStock": true, "quantity": 25},
                {"item": "Printer Paper", "category": "Paper", "price": 8.50, "inStock": true, "quantity": 150},
                {"item": "Blue Pens", "category": "Writing", "price": 3.25, "inStock": false, "quantity": 0},
                {"item": "Notebooks", "category": "Paper", "price": 5.75, "inStock": true, "quantity": 40},
                {"item": "Desk Lamp", "category": "Furniture", "price": 29.99, "inStock": true, "quantity": 8},
                {"item": "Paper Clips", "category": "Office Tools", "price": 2.10, "inStock": true, "quantity": 200},
                {"item": "Whiteboard Markers", "category": "Writing", "price": 7.80, "inStock": false, "quantity": 0},
                {"item": "File Folders", "category": "Storage", "price": 4.45, "inStock": true, "quantity": 75},
                {"item": "Ergonomic Chair", "category": "Furniture", "price": 189.99, "inStock": true, "quantity": 3},
                {"item": "Post-it Notes", "category": "Paper", "price": 6.25, "inStock": true, "quantity": 120},
                {"item": "Hole Punch", "category": "Office Tools", "price": 15.50, "inStock": false, "quantity": 0},
                {"item": "Scissors", "category": "Office Tools", "price": 9.75, "inStock": true, "quantity": 18}
            ]
        },
        {
            "dataSourceName": "csvData",
            "type": "url",
            "format": "csv",
            "url": "https://vega.github.io/editor/data/stocks.csv"
        },
        {
            "dataSourceName": "jsonUrlVariable",
            "type": "url",
            "format": "json",
            "url": "{{json_url}}"
        },
        {
            "dataSourceName": "inlineCsvData",
            "type": "inline",
            "format": "csv",
            "content": "item,price\nStapler,12.99\nPen,1.25\nLamp,29.99"
        }
    ],
    "variables": [
        {
            "variableId": "json_url",
            "type": "string",
            "initialValue": "https://vega.github.io/editor/data/barley.json"
        }
    ],
    "groups": [
        {
            "groupId": "json_data",
            "elements": [
                "## JSON Data",
                "Load data from a static JSON array.",
                {
                    "type": "tabulator",
                    "dataSourceName": "jsonData",
                    "variableId": "jsonTable",
                    "tabulatorOptions": {
                        "autoColumns": true,
                        "layout": "fitColumns",
                        "maxHeight": "100px"
                    }
                }
            ]
        },
        {
            "groupId": "csv_url",
            "elements": [
                "## CSV from URL",
                "Load CSV data from a fixed URL.",
                {
                    "type": "tabulator",
                    "dataSourceName": "csvData",
                    "variableId": "csvTable",
                    "tabulatorOptions": {
                        "autoColumns": true,
                        "layout": "fitColumns",
                        "maxHeight": "200px"
                    }
                }
            ]
        },
        {
            "groupId": "csv_url_variable",
            "elements": [
                "## Complete URL Variable (JSON)",
                "You can use a single variable for the entire JSON URL. No URL encoding is applied to the value.",
                "Note: You can also construct URLs from multiple segments (e.g., `{{host}}/{{path}}`). In that case, each segment is encoded using `encodeURIComponent`.",
                {
                    "type": "dropdown",
                    "variableId": "json_url",
                    "options": [
                        "https://vega.github.io/editor/data/barley.json",
                        "https://vega.github.io/editor/data/cars.json"
                    ]
                },
                {
                    "type": "tabulator",
                    "dataSourceName": "jsonUrlVariable",
                    "variableId": "jsonUrlTable",
                    "tabulatorOptions": {
                        "autoColumns": true,
                        "layout": "fitColumns",
                        "maxHeight": "200px"
                    }
                }
            ]
        },
        {
            "groupId": "inline_csv",
            "elements": [
                "## Inline CSV Data",
                "You can provide CSV data directly as a single string.",
                {
                    "type": "tabulator",
                    "dataSourceName": "inlineCsvData",
                    "variableId": "inlineCsvTable",
                    "tabulatorOptions": {
                        "autoColumns": true,
                        "layout": "fitColumns",
                        "maxHeight": "100px"
                    }
                }
            ]
        }
    ]
}
</textarea>
        <textarea id="markdown-input" placeholder="Type your Interactive Document markdown here..."></textarea>
    </div>
    <div id="content"></div>

    <script type="module">
        import { targetMarkdown } from './src/index.ts';
        import { Renderer } from '../markdown/src/index.js';

        const textareaJson = document.getElementById('json-input');
        const textareaMarkdown = document.getElementById('markdown-input');
        const renderer = new Renderer(document.getElementById('content'));

        window.renderer = renderer;

        function renderJson() {
            const json = textareaJson.value;
            // Convert JSON to Markdown
            try {
                const idoc = JSON.parse(json);
                const markdown = targetMarkdown(idoc);
                textareaMarkdown.value = markdown;

                renderMarkdown();
            } catch (e) {
                console.error('Invalid JSON:', e);
                return;
            }
        }

        function renderMarkdown() {
            //renderer.render(textarea.value);

            renderer.reset();
            const html = renderer.renderHtml(textareaMarkdown.value);
            renderer.element.innerHTML = html;
            const specs = renderer.hydrateSpecs();
            console.log('Specs:', specs);
            renderer.hydrate(specs);

        }

        textareaJson.addEventListener('input', renderJson);
        textareaMarkdown.addEventListener('input', renderMarkdown);

        renderJson();

    </script>

</body>

</html>