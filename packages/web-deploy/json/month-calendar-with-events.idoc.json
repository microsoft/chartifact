{
  "$schema": "../../../docs/schema/idoc_v1.json",
  "title": "Month View Events Calendar",
  "variables": [
    {
      "variableId": "selectedYear",
      "type": "number",
      "initialValue": 2025
    },
    {
      "variableId": "selectedMonth",
      "type": "number",
      "initialValue": 1
    },
    {
      "variableId": "calendarMonthList",
      "type": "object",
      "isArray": true,
      "initialValue": [],
      "calculation": {
        "dataSourceNames": [],
        "dataFrameTransformations": [
          {
            "type": "sequence",
            "start": -7,
            "stop": 38,
            "as": "dayOffset"
          },
          {
            "type": "formula",
            "as": "selectedDate",
            "expr": "datetime(selectedYear, selectedMonth - 1)"
          },
          {
            "type": "formula",
            "as": "date",
            "expr": "timeOffset('day', datum.selectedDate, datum.dayOffset)"
          },
          {
            "type": "formula",
            "expr": "day(datum.selectedDate)",
            "as": "firstWeekdayOffset"
          },
          {
            "type": "formula",
            "as": "dayOfMonth",
            "expr": "date(datum.date)"
          },
          {
            "type": "formula",
            "as": "year",
            "expr": "year(datum.date)"
          },
          {
            "type": "formula",
            "as": "weekday",
            "expr": "day(datum.date)"
          },
          {
            "type": "formula",
            "as": "month",
            "expr": "month(datum.date) + 1"
          },
          {
            "type": "formula",
            "as": "dateKey",
            "expr": "datum.year + '-' + (datum.month < 10 ? '0' + datum.month : datum.month) + '-' + (datum.dayOfMonth < 10 ? '0' + datum.dayOfMonth : datum.dayOfMonth)"
          },
          {
            "type": "formula",
            "as": "isSunday",
            "expr": "datum.weekday === 0 ? 1 : 0"
          },
          {
            "type": "window",
            "ops": [
              "sum"
            ],
            "fields": [
              "isSunday"
            ],
            "as": [
              "sundayCount"
            ],
            "frame": [
              null,
              0
            ]
          },
          {
            "type": "formula",
            "as": "inCurrentMonth",
            "expr": "month(datum.date) === selectedMonth - 1"
          },
          {
            "type": "formula",
            "as": "precedingWeek",
            "expr": "datum.weekday - datum.firstWeekdayOffset > datum.dayOffset"
          },
          {
            "type": "formula",
            "as": "nextMonth",
            "expr": "datum.dayOfMonth < 32 && datum.dayOffset > 0 && !datum.inCurrentMonth"
          },
          {
            "type": "formula",
            "expr": "datum.nextMonth && datum.weekday === 0",
            "as": "succeedingSunday"
          },
          {
            "type": "window",
            "ops": [
              "sum"
            ],
            "fields": [
              "succeedingSunday"
            ],
            "as": [
              "succeedingWeek"
            ],
            "frame": [
              null,
              0
            ]
          },
          {
            "type": "filter",
            "expr": "!datum.precedingWeek"
          },
          {
            "type": "filter",
            "expr": "!datum.succeedingWeek"
          }
        ]
      }
    },
    {
      "variableId": "eventsGrouped",
      "type": "object",
      "isArray": true,
      "initialValue": [],
      "calculation": {
        "dataSourceNames": [
          "eventsRaw"
        ],
        "dataFrameTransformations": [
          {
            "type": "aggregate",
            "groupby": [
              "date"
            ],
            "ops": [
              "values",
              "values",
              "values"
            ],
            "fields": [
              "time",
              "title",
              "category"
            ],
            "as": [
              "times",
              "titles",
              "categories"
            ]
          }
        ]
      }
    },
    {
      "variableId": "calendarWithEvents",
      "type": "object",
      "isArray": true,
      "initialValue": [],
      "calculation": {
        "dataSourceNames": [
          "calendarMonthList",
          "eventsGrouped"
        ],
        "dataFrameTransformations": [
          {
            "type": "lookup",
            "from": "eventsGrouped",
            "key": "date",
            "fields": [
              "dateKey"
            ],
            "values": [
              "times",
              "titles",
              "categories"
            ],
            "as": [
              "eventTimes",
              "eventTitles",
              "eventCategories"
            ]
          },
          {
            "type": "formula",
            "as": "eventCount",
            "expr": "datum.eventTimes ? datum.eventTimes.length : 0"
          },
          {
            "type": "formula",
            "as": "event1",
            "expr": "datum.eventTimes && datum.eventTimes.length > 0 ? datum.eventTimes[0] + ' ' + datum.eventTitles[0] : null"
          }
        ]
      }
    },
    {
      "variableId": "calendarMonthByWeek",
      "type": "object",
      "isArray": true,
      "initialValue": [],
      "calculation": {
        "dataSourceNames": [
          "calendarWithEvents"
        ],
        "dataFrameTransformations": [
          {
            "type": "nest",
            "keys": [
              "sundayCount",
              "weekday"
            ],
            "generate": true
          }
        ]
      }
    }
  ],
  "groups": [
    {
      "groupId": "header",
      "elements": [
        "# ðŸ“… Month Calendar",
        "",
        "This example demonstrates how to shape data for a calendar view using Vega transforms. Scroll down to see each step of the data transformation pipeline.",
        {
          "type": "dropdown",
          "variableId": "selectedMonth",
          "label": "Month:",
          "options": [
            "1",
            "2",
            "3",
            "4",
            "5",
            "6",
            "7",
            "8",
            "9",
            "10",
            "11",
            "12"
          ]
        },
        {
          "type": "dropdown",
          "variableId": "selectedYear",
          "label": "Year:",
          "options": [
            "2024",
            "2025",
            "2026"
          ]
        }
      ]
    },
    {
      "groupId": "rawEvents",
      "elements": [
        "## Raw Events Data",
        "This is the source data - a list of events with dates, times, titles, and categories.",
        {
          "type": "tabulator",
          "dataSourceName": "eventsRaw",
          "tabulatorOptions": {
            "autoColumns": true,
            "layout": "fitColumns",
            "maxHeight": "300px"
          }
        }
      ]
    },
    {
      "groupId": "step1",
      "elements": [
        "## Step 2: All Days of Calendar Surrounding the Selected Month",
        "Using `sequence` transform to generate all days in the selected month (7 days before and 7 after, then filtered to show Sunday to Saturday).",
        {
          "type": "tabulator",
          "dataSourceName": "calendarMonthList",
          "tabulatorOptions": {
            "autoColumns": true,
            "layout": "fitColumns",
            "maxHeight": "300px"
          }
        }
      ]
    },
    {
      "groupId": "step2",
      "elements": [
        "## Step 3: Events Grouped by Date",
        "Using `aggregate` transform to group multiple events per day into arrays.",
        {
          "type": "tabulator",
          "dataSourceName": "eventsGrouped",
          "tabulatorOptions": {
            "autoColumns": true,
            "layout": "fitColumns",
            "maxHeight": "300px"
          }
        }
      ]
    },
    {
      "groupId": "step3",
      "elements": [
        "## Step 4: Calendar with Events Joined",
        "Using `lookup` transform to join events arrays to each calendar day.",
        {
          "type": "tabulator",
          "dataSourceName": "calendarWithEvents",
          "tabulatorOptions": {
            "autoColumns": true,
            "layout": "fitColumns",
            "maxHeight": "300px"
          }
        }
      ]
    },
    {
      "groupId": "calendar",
      "elements": [
        "## Step 5: Calendar View (Treebark / HTML table)",
        {
          "type": "treebark",
          "variableId": "calendarMonthByWeek",
          "template": {
            "div": [
              {
                "table": [
                  {
                    "thead": [
                      {
                        "tr": [
                          {
                            "th": "Sun"
                          },
                          {
                            "th": "Mon"
                          },
                          {
                            "th": "Tue"
                          },
                          {
                            "th": "Wed"
                          },
                          {
                            "th": "Thu"
                          },
                          {
                            "th": "Fri"
                          },
                          {
                            "th": "Sat"
                          }
                        ]
                      }
                    ]
                  },
                  {
                    "tbody": {
                      "$bind": "root.children",
                      "$children": [
                        {
                          "tr": {
                            "$bind": "children",
                            "$children": [
                              {
                                "td": {
                                  "$bind": "data.values",
                                  "$children": [
                                    {
                                      "$if": {
                                        "$check": "inCurrentMonth",
                                        "$then": {
                                          "div": [
                                            {
                                              "div": {
                                                "$attr": {
                                                  "style": "font-weight: bold; margin-bottom: 4px"
                                                },
                                                "$children": [
                                                  "{{dayOfMonth}}"
                                                ]
                                              }
                                            },
                                            {
                                              "$if": {
                                                "$check": "eventCount",
                                                "$then": {
                                                  "div": {
                                                    "$attr": {
                                                      "style": "font-size: 0.75em; color: #666"
                                                    },
                                                    "$children": [
                                                      "{{eventCount}} event(s)"
                                                    ]
                                                  }
                                                }
                                              }
                                            },
                                            {
                                              "$if": {
                                                "$check": "eventTitles",
                                                "$then": {
                                                  "div": {
                                                    "$attr": {
                                                      "style": "font-size: 0.7em; margin-top: 2px; color: #333"
                                                    },
                                                    "$children": [
                                                      "{{eventTitles.0}}"
                                                    ]
                                                  }
                                                }
                                              }
                                            }
                                          ]
                                        }
                                      }
                                    }
                                  ]
                                }
                              }
                            ]
                          }
                        }
                      ]
                    }
                  }
                ]
              }
            ]
          }
        }
      ]
    }
  ],
  "dataLoaders": [
    {
      "dataSourceName": "eventsRaw",
      "type": "inline",
      "format": "json",
      "content": [
        {
          "date": "2025-01-01",
          "time": "All Day",
          "title": "New Year's Day",
          "category": "holiday"
        },
        {
          "date": "2025-01-06",
          "time": "09:00",
          "title": "Team Standup",
          "category": "meeting"
        },
        {
          "date": "2025-01-06",
          "time": "14:00",
          "title": "Project Review",
          "category": "work"
        },
        {
          "date": "2025-01-08",
          "time": "10:30",
          "title": "Client Meeting",
          "category": "meeting"
        },
        {
          "date": "2025-01-10",
          "time": "15:00",
          "title": "Dentist",
          "category": "personal"
        },
        {
          "date": "2025-01-13",
          "time": "09:00",
          "title": "Standup",
          "category": "meeting"
        },
        {
          "date": "2025-01-13",
          "time": "11:00",
          "title": "Design Review",
          "category": "work"
        },
        {
          "date": "2025-01-15",
          "time": "13:00",
          "title": "Lunch w/ Sarah",
          "category": "personal"
        },
        {
          "date": "2025-01-17",
          "time": "16:00",
          "title": "Code Review",
          "category": "work"
        },
        {
          "date": "2025-01-20",
          "time": "All Day",
          "title": "MLK Jr. Day",
          "category": "holiday"
        },
        {
          "date": "2025-01-20",
          "time": "09:00",
          "title": "Standup",
          "category": "meeting"
        },
        {
          "date": "2025-01-22",
          "time": "10:00",
          "title": "Sprint Planning",
          "category": "meeting"
        },
        {
          "date": "2025-01-22",
          "time": "14:00",
          "title": "Feature Demo",
          "category": "work"
        },
        {
          "date": "2025-01-24",
          "time": "18:00",
          "title": "Gym",
          "category": "personal"
        },
        {
          "date": "2025-01-27",
          "time": "09:00",
          "title": "Standup",
          "category": "meeting"
        },
        {
          "date": "2025-01-27",
          "time": "13:00",
          "title": "Budget Review",
          "category": "work"
        },
        {
          "date": "2025-01-29",
          "time": "11:00",
          "title": "1-on-1",
          "category": "meeting"
        },
        {
          "date": "2025-01-31",
          "time": "15:00",
          "title": "Month End",
          "category": "work"
        },
        {
          "date": "2025-02-03",
          "time": "09:00",
          "title": "Standup",
          "category": "meeting"
        },
        {
          "date": "2025-02-05",
          "time": "10:00",
          "title": "Q1 Planning",
          "category": "meeting"
        },
        {
          "date": "2025-02-07",
          "time": "14:00",
          "title": "Training",
          "category": "work"
        },
        {
          "date": "2025-02-10",
          "time": "09:00",
          "title": "Standup",
          "category": "meeting"
        },
        {
          "date": "2025-02-12",
          "time": "12:00",
          "title": "Team Lunch",
          "category": "personal"
        },
        {
          "date": "2025-02-14",
          "time": "All Day",
          "title": "Valentine's Day",
          "category": "holiday"
        },
        {
          "date": "2025-02-14",
          "time": "19:00",
          "title": "Dinner Date",
          "category": "personal"
        },
        {
          "date": "2025-02-17",
          "time": "All Day",
          "title": "Presidents' Day",
          "category": "holiday"
        },
        {
          "date": "2025-02-17",
          "time": "09:00",
          "title": "Standup",
          "category": "meeting"
        },
        {
          "date": "2025-02-19",
          "time": "10:30",
          "title": "Arch Review",
          "category": "work"
        },
        {
          "date": "2025-02-21",
          "time": "15:00",
          "title": "Doctor Appt",
          "category": "personal"
        },
        {
          "date": "2025-02-24",
          "time": "09:00",
          "title": "Standup",
          "category": "meeting"
        },
        {
          "date": "2025-02-26",
          "time": "11:00",
          "title": "Product Launch",
          "category": "work"
        },
        {
          "date": "2025-02-28",
          "time": "14:00",
          "title": "Sprint Retro",
          "category": "meeting"
        }
      ]
    }
  ]
}
